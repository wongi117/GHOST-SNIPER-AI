<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üëª Ghost Sniper ‚Äî Wallet Connect</title>

  <!-- Optional: if you already have /public/ghost.css, keep it.
       Otherwise the inline styles below are enough. -->
  <style>
    :root { --bg:#0b1220; --card:#0f1a33; --muted:#9fb5d9; --txt:#fff; --accent:#7ef29a; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--txt); font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { display:flex; gap:12px; align-items:center; padding:16px 20px; border-bottom:1px solid #1f2a40; }
    h1 { margin:0; font-size:20px; }
    .sub { color:var(--muted); font-size:13px; }
    .wrap { max-width:1100px; margin:18px auto; padding:0 16px; display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 960px) { .wrap { grid-template-columns: 1fr 1fr; } }
    .card { background:var(--card); border:1px solid #1a2949; border-radius:12px; padding:16px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .col { display:flex; flex-direction:column; gap:8px; }
    .muted { color:var(--muted); font-size:13px; }
    .badge { display:inline-block; background:#1b2a4a; border:1px solid #2a3b60; padding:4px 8px; border-radius:999px; font-size:12px; color:#a9c0e6; }
    button { appearance:none; border:none; background:#213bff; color:#fff; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    button.sec { background:#2a3957; }
    button.ghost { background:transparent; border:1px solid #2a3b60; color:#cfe0ff; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    pre { margin:0; padding:10px; background:#0c1529; border:1px solid #1a2949; border-radius:8px; overflow:auto; color:#bfe2ff; }
    a { color:#9cd1ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>

  <!-- Solana web3 for convenience (Phantom not required, but nice to have) -->
  <script defer src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
</head>
<body>
  <header>
    <h1>üëª Ghost Sniper</h1>
    <span class="badge">You sign ‚Äî no keys on server</span>
  </header>

  <div class="wrap">

    <!-- Phantom / Solana -->
    <section class="card">
      <h2 style="margin:0 0 6px">Solana ‚Äî Phantom</h2>
      <p class="muted">On iPhone, wallets inject only inside the Phantom app. Use the button below to open this site in Phantom.</p>

      <div class="row" style="margin:10px 0 6px">
        <button id="phantomConnect">Connect Phantom</button>
        <button id="openInPhantom" class="sec" style="display:none">Open in Phantom (iPhone)</button>
        <button id="phantomSign" class="ghost" disabled>Sign Test Message</button>
      </div>

      <div class="col">
        <div class="muted">Address</div>
        <pre id="phantomAddr">‚Äî</pre>
        <div class="muted">Last Result</div>
        <pre id="phantomOut">‚Äî</pre>
      </div>
    </section>

    <!-- MetaMask / EVM -->
    <section class="card">
      <h2 style="margin:0 0 6px">Ethereum ‚Äî MetaMask</h2>
      <p class="muted">Works in any Chromium browser and in MetaMask mobile in-app browser.</p>

      <div class="row" style="margin:10px 0 6px">
        <button id="mmConnect">Connect MetaMask</button>
        <button id="mmSign" class="ghost" disabled>Sign Test Message</button>
      </div>

      <div class="col">
        <div class="muted">Address</div>
        <pre id="mmAddr">‚Äî</pre>
        <div class="muted">Last Result</div>
        <pre id="mmOut">‚Äî</pre>
      </div>
    </section>

    <!-- Links / Tools -->
    <section class="card">
      <h2 style="margin:0 0 6px">Tools</h2>
      <div class="col">
        <a href="/wallet-test" target="_blank">üîç Open Wallet Test page</a>
        <a href="/health" target="_blank">üíì /health</a>
        <a href="https://phantom.app/ul" target="_blank">üì± Phantom Universal Links (docs)</a>
      </div>
    </section>

  </div>

  <script>
    // ------- helpers
    const $ = (id) => document.getElementById(id);
    const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);

    // ------- Phantom (Solana)
    (function setupPhantom(){
      const btnConnect = $('phantomConnect');
      const btnOpen = $('openInPhantom');
      const btnSign = $('phantomSign');
      const addrEl = $('phantomAddr');
      const outEl = $('phantomOut');

      const injected = !!(window.phantom && window.phantom.solana);
      if (!injected && isIOS) {
        // Show "Open in Phantom" for Safari on iOS
        btnOpen.style.display = 'inline-block';
        btnOpen.onclick = () => {
          const here = window.location.href;
          // Open current URL inside Phantom app
          window.location.href = 'https://phantom.app/ul/browse/' + encodeURIComponent(here);
        };
      }

      btnConnect.onclick = async () => {
        try {
          if (!(window.phantom && window.phantom.solana)) {
            outEl.textContent = 'Phantom not injected. On iPhone, tap "Open in Phantom". On desktop, install Phantom.';
            return;
          }
          const provider = window.phantom.solana;
          const resp = await provider.connect({ onlyIfTrusted: false });
          const pubkey = resp.publicKey?.toString?.() || '(no key)';
          addrEl.textContent = pubkey;
          btnSign.disabled = false;
          outEl.textContent = 'Connected ‚úÖ';
        } catch (e) {
          outEl.textContent = 'Connect error: ' + String(e?.message || e);
        }
      };

      btnSign.onclick = async () => {
        try {
          const provider = window.phantom?.solana;
          if (!provider?.isPhantom) throw new Error('Phantom not available');
          const msg = new TextEncoder().encode('Ghost Sniper test ' + new Date().toISOString());
          const sig = await provider.signMessage(msg, 'utf8');
          outEl.textContent = 'Signature (base58): ' + (sig?.signature ? toBase58(sig.signature) : JSON.stringify(sig));
        } catch (e) {
          outEl.textContent = 'Sign error: ' + String(e?.message || e);
        }
      };

      // base58 encoder (tiny)
      const toBase58 = (bytes) => {
        const ALPH='123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
        let x = BigInt('0x' + [...bytes].map(b=>b.toString(16).padStart(2,'0')).join(''));
        let out='';
        while (x>0n){ out=ALPH[Number(x%58n)]+out; x/=58n; }
        for (const b of bytes) { if (b===0) out='1'+out; else break; }
        return out || '1';
      };
    })();

    // ------- MetaMask (EVM)
    (function setupMetaMask(){
      const btnConnect = $('mmConnect');
      const btnSign = $('mmSign');
      const addrEl = $('mmAddr');
      const outEl = $('mmOut');

      btnConnect.onclick = async () => {
        try {
          if (!window.ethereum) {
            outEl.textContent = 'MetaMask not found. Install MetaMask or open this site inside the MetaMask app browser.';
            return;
          }
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const addr = accounts?.[0] || '(no account)';
          addrEl.textContent = addr;
          btnSign.disabled = false;
          outEl.textContent = 'Connected ‚úÖ';
        } catch (e) {
          outEl.textContent = 'Connect error: ' + String(e?.message || e);
        }
      };

      btnSign.onclick = async () => {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const from = accounts[0];
          const msg = 'Ghost Sniper test ' + new Date().toISOString();
          // personal_sign expects hex data OR a UTF-8 string (MM converts)
          const sig = await window.ethereum.request({
            method: 'personal_sign',
            params: [msg, from]
          });
          outEl.textContent = 'Signature: ' + sig;
        } catch (e) {
          outEl.textContent = 'Sign error: ' + String(e?.message || e);
        }
      };
    })();
  </script>
</body>
</html>