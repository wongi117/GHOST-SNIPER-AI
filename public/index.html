<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>üëª Ghost Sniper ‚Äî Live</title>
<style>
:root{--bg:#0b1220;--card:#0f1a33;--muted:#9fb5d9;--ok:#2ecc71;--bad:#ff6b6b}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{display:flex;gap:12px;align-items:center;padding:14px 18px;border-bottom:1px solid #1f2a40;position:sticky;top:0;background:#0b1220cc;backdrop-filter:blur(8px);z-index:10}
h1{margin:0;font-size:20px}
.sub{color:var(--muted);font-size:13px}
.wrap{max-width:1250px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1.1fr 1fr;gap:14px}
@media(max-width:1020px){.wrap{display:block}}
.card{background:var(--card);border:1px solid #1f2a40;border-radius:12px;overflow:hidden}
.card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2a40;font-size:16px}
.section{padding:12px 14px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.kv{display:grid;grid-template-columns:110px 1fr;gap:8px;align-items:center}
input,select,textarea{background:#0b1326;border:1px solid #1f2a40;border-radius:8px;color:#fff;padding:9px 10px;font:14px/1.2 inherit;width:100%}
input[type="number"]{max-width:130px}
.badge{display:inline-block;padding:3px 8px;border:1px solid #1f2a40;border-radius:999px;font-size:12px;color:var(--muted)}
.btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:600;color:#fff;cursor:pointer}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.primary{background:#2166ff}
.btn.ok{background:#2a3957}
.btn.sell{background:#a03d3d}
a{color:#9cd1ff;text-decoration:none}a:hover{text-decoration:underline}
hr{border:none;border-top:1px solid #1f2a40;margin:12px 0}
pre{white-space:pre-wrap;background:#081127;border:1px solid #1f2a40;padding:10px;border-radius:10px;max-height:36vh;overflow:auto}
.list{display:grid;gap:8px}
.item{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px;border:1px solid #1f2a40;border-radius:10px;background:#0b1326}
.item .meta{color:var(--muted);font-size:12px}
.small{font-size:12px;color:var(--muted)}
.tag{font-size:11px;padding:2px 6px;border:1px solid #1f2a40;border-radius:999px;margin-left:6px}
.pnl-pos{color:var(--ok)} .pnl-neg{color:var(--bad)}
</style>
<script defer src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
</head>
<body>
<header>
  <h1>üëª Ghost Sniper</h1>
  <div class="sub">Connect ‚Üí pick target ‚Üí quote ‚Üí sign ‚Üí swap. No keys on server.</div>
</header>

<div class="wrap">
  <!-- LEFT: Intel + feed -->
  <section class="card">
    <h2>üì° Market Intel</h2>
    <div class="section">
      <div class="row">
        <span class="badge" id="solp">SOL $‚Äì</span>
        <span class="badge">Jupiter v6</span>
        <span class="badge">DexScreener</span>
      </div>

      <hr/>
      <div class="row">
        <input id="ingestUrl" placeholder="Paste YouTube / TikTok / article URL for AI summary"/>
        <button class="btn ok" id="btnIngest">Summarize</button>
      </div>
      <pre id="summary" class="small">Tip: paste a link. The server fetches text; AI summarizes for your playbook.</pre>
    </div>

    <h2>‚ö° New Pairs (DexScreener ¬∑ Solana)</h2>
    <div class="section">
      <div class="row">
        <input id="filter" placeholder="filter symbol / pump / raydium‚Ä¶"/>
        <button class="btn ok" id="btnReload">Reload</button>
      </div>
      <div id="feed" class="list" style="margin-top:10px"></div>
      <div class="small" style="margin-top:10px">Source: DexScreener latest SOL pairs. ‚ÄúSnipe‚Äù = SOL‚Üíbase.</div>
    </div>
  </section>

  <!-- RIGHT: Wallet + Sniper + Positions -->
  <section class="card">
    <h2>üß∞ Wallet & Sniper</h2>
    <div class="section">
      <div class="row">
        <button class="btn ok" id="openPhantom" style="display:none">Open Phantom (iOS)</button>
        <button class="btn primary" id="connectPhantom">Connect Phantom</button>
      </div>
      <div class="kv" style="margin-top:8px">
        <div>Address</div><input id="addr" readonly placeholder="‚Äî"/>
        <div>Amount (SOL)</div><input id="amt" type="number" step="0.001" value="0.02"/>
        <div>Slippage (bps)</div><input id="slip" type="number" step="1" value="100"/>
        <div>Priority (SOL)</div><input id="prio" type="number" step="0.000001" value="0.0005"/>
      </div>
      <hr/>
      <div class="kv">
        <div>Input</div>
        <select id="inMint">
          <option value="So11111111111111111111111111111111111111112">SOL</option>
          <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
        </select>
        <div>Output</div>
        <input id="outMint" placeholder="Target token mint (from feed or paste)"/>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="btnQuote">Get Quote</button>
        <button class="btn primary" id="btnSwap" disabled>Sign & Swap</button>
        <button class="btn sell" id="btnSell" disabled>Quick Sell (reverse)</button>
      </div>
      <hr/>
      <div class="row">
        <label><input type="checkbox" id="takeProfit" checked> TP +12%</label>
        <label><input type="checkbox" id="stopLoss" checked> SL -8%</label>
        <label><input type="checkbox" id="autoSell"> Auto-sell thin liq</label>
      </div>
      <hr/>
      <pre id="log">Ready.\n</pre>
    </div>

    <h2>üìí Positions</h2>
    <div class="section">
      <div class="small" style="margin-bottom:8px">Local to your browser (no server custody). Auto TP/SL is evaluated here; sells still require your signature.</div>
      <div id="positions" class="list"></div>
    </div>
  </section>
</div>

<script>
const log=(...a)=>{const el=$('log');el.textContent+=a.join(' ')+'\\n';el.scrollTop=el.scrollHeight}
const $=id=>document.getElementById(id);
const SOL_MINT="So11111111111111111111111111111111111111112";
let phantom,pubkey,lastQuote;

const store={
  key:()=>`positions:v1:${pubkey||'anon'}`,
  get(){try{return JSON.parse(localStorage.getItem(this.key())||'[]')}catch{return[]}},
  set(v){localStorage.setItem(this.key(),JSON.stringify(v))}
};

// iOS helper
(function(){const isIOS=/iPhone|iPad|iPod/.test(navigator.userAgent); if(isIOS)$('openPhantom').style.display='inline-block';
 $('openPhantom').onclick=()=>location.href="https://phantom.app/ul/browse/"+encodeURIComponent(location.href)})();

// Connect
$('connectPhantom').onclick=async()=>{
  try{
    if(!window.solana?.isPhantom){log("Install Phantom and re-open.");return}
    phantom=window.solana; const r=await phantom.connect();
    pubkey=r.publicKey.toString(); $('addr').value=pubkey; log("Phantom:",pubkey);
    renderPositions(); // switch namespace
  }catch(e){log("connect_error:",e.message||e)}
};

// Prices
async function refreshSolPrice(){try{const r=await fetch('/api/price/sol'); const j=await r.json(); if(j?.usd)$('solp').textContent=`SOL $${j.usd}`}catch{}}
refreshSolPrice(); setInterval(refreshSolPrice,30_000);

// AI ingest
$('btnIngest').onclick=async()=>{
  const url=$('ingestUrl').value.trim(); if(!url)return; $('summary').textContent="Summarizing‚Ä¶";
  try{const r=await fetch('/api/ingest',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({url})});
    const j=await r.json(); $('summary').textContent=j.summary||JSON.stringify(j,null,2)}
  catch(e){$('summary').textContent="Ingest failed: "+(e.message||e)}
};

// Feed
$('btnReload').onclick=loadFeed; loadFeed(); setInterval(loadFeed,20_000);
async function loadFeed(){
  $('feed').innerHTML='<div class="small">Loading‚Ä¶</div>';
  try{
    const r=await fetch('/api/dexscreener/new'); const j=await r.json(); const q=$('filter').value.trim().toLowerCase();
    const items=(j.items||[]).filter(x=>{const s=`${x.baseSymbol} ${x.quoteSymbol} ${x.dexId} ${x.url} ${(x.flags||[]).join(' ')}`.toLowerCase();return q? s.includes(q):true});
    $('feed').innerHTML=''; items.forEach(p=>{
      const row=document.createElement('div'); row.className='item';
      row.innerHTML=`<div>
        <div><b>${p.baseSymbol||'???'}</b> / ${p.quoteSymbol} ¬∑ ${p.dexId} ¬∑ <a href="${p.url}" target="_blank">chart</a>
          <span class="tag">liq $${fmt(p.liquidityUsd,0)}</span>
          <span class="tag">FDV $${fmt(p.fdv,0)}</span>
        </div>
        <div class="meta small">${p.baseAddress}</div></div>
        <div class="row"><button class="btn ok">Quote</button><button class="btn primary">Snipe</button></div>`;
      const [bq,bs]=row.querySelectorAll('button');
      bq.onclick=()=>quote(SOL_MINT,p.baseAddress);
      bs.onclick=()=>snipe(SOL_MINT,p.baseAddress);
      $('feed').appendChild(row);
    });
  }catch(e){$('feed').innerHTML=`<div class="small">Feed error: ${e.message||e}</div>`}
}

// Quote & Swap
$('btnQuote').onclick=()=>quote($('inMint').value,$('outMint').value);
async function quote(inputMint,outputMint){
  try{
    if(!pubkey) throw new Error("Connect wallet first");
    if(!outputMint) outputMint=$('outMint').value.trim(); if(!outputMint) throw new Error("Set output mint");
    $('outMint').value=outputMint;
    const lamports = m=>Math.round(Number(m)*1e9);
    const amountLamports = inputMint===SOL_MINT ? lamports($('amt').value||"0.02") : Math.round(Number($('amt').value||"1")*1e6);
    const q=new URL('/api/jup/quote',location.origin);
    q.searchParams.set('inputMint',inputMint); q.searchParams.set('outputMint',outputMint);
    q.searchParams.set('amount',amountLamports); q.searchParams.set('slippageBps',$('slip').value||"100");
    log("Quoting‚Ä¶"); const r=await fetch(q); const j=await r.json();
    if(!j?.outAmount){log("Quote failed:",JSON.stringify(j)); return}
    lastQuote=j; $('btnSwap').disabled=false; $('btnSell').disabled=false;
    log(`Quote ok: in ${j.inAmount} ‚Üí out ${j.outAmount} hops:${j.routePlan?.length||1}`);
  }catch(e){log("quote_error:",e.message||e)}
}

$('btnSwap').onclick=async()=>{ // BUY
  try{
    if(!pubkey) throw new Error("Connect wallet first");
    if(!lastQuote) throw new Error("Get a quote first");
    log("Building swap‚Ä¶");
    const r=await fetch('/api/jup/swap',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({quoteResponse:lastQuote,userPublicKey:pubkey,wrapAndUnwrapSol:true})});
    const j=await r.json(); if(!j.swapTransaction){log("swap_build_error:",JSON.stringify(j)); return}
    const txBytes=Uint8Array.from(atob(j.swapTransaction),c=>c.charCodeAt(0));
    const { signature } = await window.solana.signAndSendTransaction({ serializedTransaction: txBytes });
    log("Submitted:",signature);

    // Track position locally (approximate)
    const outMint=$('outMint').value.trim();
    const entryPriceUsd=await priceUsd(outMint);
    const sizeSol=Number($('amt').value||"0.02");
    const tp=$('takeProfit').checked?0.12:0; const sl=$('stopLoss').checked?0.08:0;
    const list=store.get();
    list.push({ mint: outMint, sizeSol, entryPriceUsd, tp, sl, active:true, createdAt:Date.now(), signature });
    store.set(list); renderPositions();
  }catch(e){log("swap_error:",e.message||e)}
};

$('btnSell').onclick=async()=>{ // reverse quick sell
  try{
    const inMint=$('outMint').value.trim(); if(!inMint) throw new Error("No output mint set");
    const outMint=$('inMint').value;
    await quote(inMint,outMint);
    $('btnSwap').click();
  }catch(e){log("sell_error:",e.message||e)}
};

async function snipe(inMint,outMint){$('inMint').value=inMint;$('outMint').value=outMint;await quote(inMint,outMint);$('btnSwap').click()}

// Positions
function renderPositions(){
  const box=$('positions'); box.innerHTML='';
  const list=store.get().filter(p=>p.active);
  if(!list.length){box.innerHTML='<div class="small">No active positions.</div>'; return;}
  list.forEach((p,idx)=>{
    const row=document.createElement('div'); row.className='item'; row.id=`pos-${idx}`;
    row.innerHTML=`<div>
      <div><b>${p.mint.slice(0,6)}‚Ä¶${p.mint.slice(-5)}</b>
        <span class="tag">size ~ ${p.sizeSol} SOL</span>
        <span class="tag">entry $${fmt(p.entryPriceUsd)}</span>
        <span class="tag">TP ${Math.round(p.tp*100)}% / SL ${Math.round(p.sl*100)}%</span>
      </div>
      <div class="meta small" id="meta-${idx}">‚Äî</div>
    </div>
    <div class="row">
      <button class="btn primary" id="sell-${idx}">Sell</button>
      <button class="btn ok" id="off-${idx}">${p.active?'Disable':'Enable'}</button>
    </div>`;
    box.appendChild(row);
    $('sell-'+idx).onclick=()=>manualSell(p);
    $('off-'+idx).onclick=()=>togglePos(idx);
  });
}
function togglePos(i){const list=store.get(); list[i].active=!list[i].active; store.set(list); renderPositions()}
async function manualSell(p){ $('outMint').value=SOL_MINT; await quote(p.mint,SOL_MINT); $('btnSwap').click(); }

// Auto TP/SL loop
setInterval(async ()=>{
  const list=store.get(); if(!list.length || !pubkey) return;
  for (let i=0;i<list.length;i++){
    const p=list[i]; if(!p.active) continue;
    const px=await priceUsd(p.mint); if(!px) continue;
    const change=(px - p.entryPriceUsd)/p.entryPriceUsd;
    const meta=$('meta-'+i); if(meta){
      const cls = change>=0 ? 'pnl-pos':'pnl-neg';
      meta.innerHTML = `now $${fmt(px)} ¬∑ <span class="${cls}">${(change*100).toFixed(2)}%</span>`;
    }
    // thin-liquidity auto-sell hook (optional): you could fetch liquidity with /api/dex/price and check p.liquidityUsd
    if (p.tp && change>=p.tp){ log("TP hit ‚Üí sell", p.mint); await quote(p.mint,SOL_MINT); $('btnSwap').click(); p.active=false; }
    if (p.sl && change<=-p.sl){ log("SL hit ‚Üí sell", p.mint); await quote(p.mint,SOL_MINT); $('btnSwap').click(); p.active=false; }
  }
  store.set(list); renderPositions();
}, 5000);

// Utils
async function priceUsd(mint){ try{ const r=await fetch(`/api/dex/price?token=${mint}`); const j=await r.json(); return Number(j?.priceUsd||0)||null } catch { return null } }
const fmt=(n,d=4)=>Number(n||0).toFixed(d);

// init
$('summary').textContent += "";
</script>
</body>
</html>