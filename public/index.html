<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üëª Ghost Sniper ‚Äî Live</title>
  <style>
    :root{--bg:#0b1220;--card:#0f1a33;--muted:#9fb5d9;--ok:#25c39e}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#fff;font:15px/1.4 system-ui,Segoe UI,Arial}
    header{display:flex;gap:10px;align-items:baseline;padding:16px 18px;border-bottom:1px solid #1f2a40}
    h1{margin:0;font-size:22px} .sub{color:var(--muted);font-size:13px}
    .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
    .grid{display:grid;gap:12px}
    @media (min-width: 980px){ .grid{grid-template-columns: 1.1fr .9fr} }
    .card{background:var(--card);border:1px solid #1f2a40;border-radius:10px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{min-width:120px;font-size:13px;color:var(--muted)}
    input,select{background:#0b1326;border:1px solid #1f2a40;color:#fff;border-radius:8px;padding:10px 12px;outline:none}
    input:focus,select:focus{border-color:#2a6bff}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;color:#fff;cursor:pointer}
    .pri{background:#2166ff} .sec{background:#2a3957}
    .ok{color:var(--ok)} .muted{color:var(--muted)}
    pre{background:#0a0f1d;border:1px solid #1f2a40;border-radius:10px;padding:12px;white-space:pre-wrap;max-height:260px;overflow:auto}
    a, .link{color:#9cd1ff;text-decoration:none} a:hover{ text-decoration: underline }
    hr{border:none;border-top:1px solid #1f2a40;margin:12px 0}
    .badge{display:inline-block;background:#132244;border:1px solid #1f2a40;border-radius:999px;padding:3px 8px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>üëª Ghost Sniper</h1>
    <div class="sub">Connect ‚Üí quote ‚Üí sign & send. You sign ‚Äî no keys on server.</div>
  </header>

  <div class="wrap grid">
    <!-- LEFT: Wallet & Sniper controls -->
    <section class="card">
      <h2 style="margin:0 0 12px 0;">‚öôÔ∏è Wallet & Quick Trade</h2>

      <!-- iPhone helper -->
      <div class="row" id="iosHelperRow" style="display:none;margin-bottom:8px;">
        <button class="btn sec" id="openPhantomBtn">Open Phantom (iPhone)</button>
        <span class="muted">Use this on iOS Safari to allow wallet injection.</span>
      </div>

      <!-- Connect row -->
      <div class="row" style="margin-bottom:10px;">
        <button class="btn pri" id="connectPhantom">Connect Phantom</button>
        <span class="badge" id="walletLabel">Wallet: <span class="muted">Not connected</span></span>
      </div>

      <!-- Inputs -->
      <div class="row">
        <label>Amount (SOL)</label>
        <input id="amt" type="number" step="0.0001" value="0.01" style="width:140px" />
        <label>Slippage (bps)</label>
        <input id="slip" type="number" step="1" value="50" style="width:120px" />
      </div>
      <div class="row" style="margin-top:8px;">
        <label>Pool</label>
        <select id="pool" style="width:160px">
          <option value="pumpfun" selected>Pump.fun</option>
          <option value="jup">Jupiter Route</option>
        </select>

        <label>Pair</label>
        <select id="pair" style="min-width:220px">
          <option value="SOL-USDC">SOL ‚Üí USDC</option>
          <option value="USDC-SOL">USDC ‚Üí SOL</option>
        </select>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn pri" id="btnQuote">Get Quote</button>
        <button class="btn sec" id="btnSwap">Swap</button>
        <span class="muted">Test tiny sizes first.</span>
      </div>

      <hr />

      <div class="row">
        <label>Paste a YouTube/TikTok URL</label>
        <input id="mediaUrl" placeholder="https://youtube.com/‚Ä¶ or https://www.tiktok.com/‚Ä¶" style="flex:1 1 340px" />
        <button class="btn sec" id="btnIngest">Ingest</button>
      </div>
      <div class="muted" style="margin-top:6px">
        Server will fetch captions/transcripts, summarize, and cache. Then you can ask the AI about the video.
      </div>
    </section>

    <!-- RIGHT: Console output -->
    <section class="card">
      <h2 style="margin:0 0 12px 0;">üßµ Console</h2>
      <pre id="out">Ready</pre>
    </section>
  </div>

  <script>
    // ---------- Utility logging ----------
    const $ = (sel) => document.querySelector(sel);
    const out = $('#out');
    function log(...args){ out.textContent += '\\n' + args.map(a => typeof a==='string'?a:JSON.stringify(a,null,2)).join(' '); out.scrollTop = out.scrollHeight; }
    function setWalletLabel(text, ok=false){ $('#walletLabel').innerHTML = 'Wallet: ' + (ok ? '<span class="ok">'+text+'</span>' : '<span class="muted">'+text+'</span>'); }

    // ---------- iOS helper visibility ----------
    const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
    if(isIOS){ $('#iosHelperRow').style.display = 'flex'; }
    $('#openPhantomBtn')?.addEventListener('click', ()=>{ location.href = 'https://phantom.app/ul/browse/'+encodeURIComponent(location.href); });

    // ---------- Phantom connect ----------
    let walletAddr = null;
    $('#connectPhantom').addEventListener('click', async () => {
      try{
        if(!window.solana){
          log('Phantom not injected. If on iOS, tap "Open Phantom" first.');
          setWalletLabel('Not injected'); return;
        }
        const resp = await window.solana.connect();
        walletAddr = resp.publicKey?.toString?.() || resp.publicKey;
        setWalletLabel(walletAddr, true);
        log('Phantom connected:', walletAddr);
      }catch(e){
        log('connect error:', String(e));
      }
    });

    // ---------- Mint dictionary (quick presets) ----------
    const MINTS = {
      SOL:  'So11111111111111111111111111111111111111112', // WSOL
      USDC: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'
    };
    function getPairMints(pair){
      if(pair === 'SOL-USDC') return { inputMint: MINTS.SOL,  outputMint: MINTS.USDC };
      if(pair === 'USDC-SOL') return { inputMint: MINTS.USDC, outputMint: MINTS.SOL  };
      throw new Error('Unsupported pair selection');
    }

    // ---------- Quote ----------
    let lastQuote = null;
    $('#btnQuote').addEventListener('click', async () => {
      try{
        const { inputMint, outputMint } = getPairMints($('#pair').value);
        const amountSol = Number($('#amt').value || '0');
        if(!amountSol || amountSol <= 0) throw new Error('Enter amount');

        let amount = amountSol;
        if(inputMint === MINTS.SOL){
          amount = Math.round(amountSol * 1e9);   // lamports
        } else {
          amount = Math.round(amountSol * 1e6);   // crude for USDC
        }

        const u = new URL('/api/jup/quote', location.origin);
        u.searchParams.set('inputMint', inputMint);
        u.searchParams.set('outputMint', outputMint);
        u.searchParams.set('amount', String(amount));
        u.searchParams.set('slippageBps', String(Number($('#slip').value || '50')));

        log('Fetching quote‚Ä¶');
        const q = await fetch(u).then(r=>r.json());
        lastQuote = q?.data || null;
        if(!lastQuote) throw new Error('No route from Jupiter');
        log('QUOTE OK', { in: inputMint, out: outputMint, amount, outAmount: lastQuote?.outAmount });
      }catch(e){
        log('quote error:', String(e));
      }
    });

    // ---------- Swap (sign & send with Phantom) ----------
    $('#btnSwap').addEventListener('click', async () => {
      try{
        if(!walletAddr){ throw new Error('Connect Phantom first'); }
        if(!lastQuote){ throw new Error('Get a quote first'); }

        log('Building swap tx‚Ä¶');
        const res = await fetch('/api/jup/swap', {
          method: 'POST',
          headers: { 'content-type':'application/json' },
          body: JSON.stringify({
            userPublicKey: walletAddr,
            wrapAndUnwrapSol: true,
            quoteResponse: lastQuote
          })
        }).then(r=>r.json());

        const txB64 = res?.swapTransaction;
        if(!txB64){ throw new Error('Bad swap response from server'); }

        const txBytes = Uint8Array.from(atob(txB64), c => c.charCodeAt(0));
        log('Requesting Phantom to sign & send‚Ä¶');

        // Phantom accepts { message: Uint8Array } for serialized
        const signed = await window.solana.signAndSendTransaction({ message: txBytes });
        const sig = signed?.signature || signed;
        log('‚úÖ sent:', sig);
      }catch(e){
        log('swap error:', String(e));
      }
    });

    // ---------- Ingest (YouTube/TikTok/Article) ----------
    $('#btnIngest').addEventListener('click', async () => {
      try{
        const url = ($('#mediaUrl').value || '').trim();
        if(!url) throw new Error('Paste a media URL first');
        log('Ingesting:', url);
        const j = await fetch('/api/ingest', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ url })
        }).then(r=>r.json());
        log('INGEST OK', j);
      }catch(e){
        log('ingest error:', String(e));
      }
    });

    // ---------- Tips ----------
    log('Tips:');
    log('‚Ä¢ On iPhone, tap "Open Phantom" first so the wallet can inject into Safari.');
    log('‚Ä¢ Start with small amounts; slippage is in basis points (50 = 0.50%).');
    log('‚Ä¢ You always sign locally; the server never sees your keys.');
  </script>
</body>
</html>